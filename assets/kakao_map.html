<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Kakao Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ì •ë³´ì°½ ìŠ¤íƒ€ì¼ */
        .kakao_maps_sdk_infowindow {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            transition: all 0.3s ease-in-out;
        }

        /* ì¹´ì¹´ì˜¤ë§µ InfoWindowì˜ ëª¨ë“  border ì œê±° */
        .kakao_maps_sdk_infowindow * {
            border: none !important;
            outline: none !important;
        }

        /* ì¹´ì¹´ì˜¤ë§µ InfoWindow ìì²´ì˜ border ì œê±° */
        .kakao_maps_sdk_infowindow,
        .kakao_maps_sdk_infowindow>div,
        .kakao_maps_sdk_infowindow>div>div {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }

        /* ëª¨ë“  ê°€ëŠ¥í•œ border í´ë˜ìŠ¤ ì œê±° */
        .kakao_maps_sdk_infowindow [class*="border"],
        .kakao_maps_sdk_infowindow [class*="Border"],
        .kakao_maps_sdk_infowindow [style*="border"] {
            border: none !important;
            outline: none !important;
        }

        /* ì¶”ê°€: ì¹´ì¹´ì˜¤ë§µ InfoWindowì˜ ëª¨ë“  ìŠ¤íƒ€ì¼ ì¬ì •ì˜ */
        .kakao_maps_sdk_infowindow,
        .kakao_maps_sdk_infowindow *,
        .kakao_maps_sdk_infowindow *::before,
        .kakao_maps_sdk_infowindow *::after {
            border: none !important;
            outline: none !important;
            border-radius: 16px !important;
        }

        /* InfoWindow ì»¨í…Œì´ë„ˆ ìì²´ì˜ border ì œê±° */
        .kakao_maps_sdk_infowindow {
            border: none !important;
            outline: none !important;
            background: transparent !important;
        }

        /* ëª¨ë“  InfoWindow ê´€ë ¨ ìš”ì†Œì˜ border ê°•ì œ ì œê±° */
        .kakao_maps_sdk_infowindow,
        .kakao_maps_sdk_infowindow *,
        .kakao_maps_sdk_infowindow *::before,
        .kakao_maps_sdk_infowindow *::after,
        .kakao_maps_sdk_infowindow>div,
        .kakao_maps_sdk_infowindow>div>div,
        .kakao_maps_sdk_infowindow>div>div>div {
            border: none !important;
            outline: none !important;
            border-width: 0 !important;
            border-style: none !important;
            border-color: transparent !important;
        }

        /* ì¹´ì¹´ì˜¤ë§µ ê¸°ë³¸ InfoWindow ìŠ¤íƒ€ì¼ ì™„ì „ ì¬ì •ì˜ */
        .kakao_maps_sdk_infowindow {
            border: none !important;
            outline: none !important;
            background: transparent !important;
            box-shadow: none !important;
        }

        /* InfoWindow ë‚´ë¶€ ëª¨ë“  ìš”ì†Œ border ì œê±° */
        .kakao_maps_sdk_infowindow div,
        .kakao_maps_sdk_infowindow span,
        .kakao_maps_sdk_infowindow button,
        .kakao_maps_sdk_infowindow input {
            border: none !important;
            outline: none !important;
        }

        /* ì¹´ì¹´ì˜¤ë§µ InfoWindowì˜ ëª¨ë“  ê°€ëŠ¥í•œ border ìŠ¤íƒ€ì¼ ì™„ì „ ì œê±° */
        .kakao_maps_sdk_infowindow,
        .kakao_maps_sdk_infowindow *,
        .kakao_maps_sdk_infowindow *::before,
        .kakao_maps_sdk_infowindow *::after {
            border: none !important;
            outline: none !important;
            border-width: 0 !important;
            border-style: none !important;
            border-color: transparent !important;
            border-top: none !important;
            border-right: none !important;
            border-bottom: none !important;
            border-left: none !important;
            box-shadow: none !important;
        }

        /* ì¹´ì¹´ì˜¤ë§µ ê¸°ë³¸ InfoWindow ìŠ¤íƒ€ì¼ ì™„ì „ ì¬ì •ì˜ */
        .kakao_maps_sdk_infowindow {
            border: none !important;
            outline: none !important;
            background: transparent !important;
            box-shadow: none !important;
            border-radius: 16px !important;
        }

        /* ì¶”ê°€: ëª¨ë“  InfoWindow ê´€ë ¨ í´ë˜ìŠ¤ì— border ì œê±° */
        [class*="infowindow"],
        [class*="InfoWindow"],
        [class*="info-window"],
        [class*="info_window"] {
            border: none !important;
            outline: none !important;
            border-width: 0 !important;
            border-style: none !important;
            border-color: transparent !important;
        }

        /* InfoWindow ë°°ê²½ ì œê±° */
        .kakao_maps_sdk_infowindow,
        .kakao_maps_sdk_infowindow *,
        [class*="infowindow"],
        [class*="InfoWindow"],
        [class*="info-window"],
        [class*="info_window"] {
            border: none !important;
            outline: none !important;
            border-width: 0 !important;
            border-style: none !important;
            border-color: transparent !important;
        }

        /* ì¹´ì¹´ì˜¤ë§µ ê¸°ë³¸ InfoWindow ë°°ê²½ ì™„ì „ ì œê±° */
        .kakao_maps_sdk_infowindow {
            background: transparent !important;
            background-color: transparent !important;
            background-image: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        /* InfoWindow ì»¨í…Œì´ë„ˆ ë°°ê²½ ì œê±° (ì™¸ë¶€ ë°˜íˆ¬ëª… ì˜ì—­) */
        .kakao_maps_sdk_infowindow>div:first-child {
            background: transparent !important;
            background-color: transparent !important;
            background-image: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        /* InfoWindow ë‚´ìš© ì˜ì—­ë§Œ ë°°ê²½ ìœ ì§€ */
        .infowindow-content {
            background: linear-gradient(145deg, #ffffff, #f8f9fa) !important;
            background-color: #ffffff !important;
            border-radius: 16px !important;
            overflow: hidden !important;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08) !important;
        }

        /* InfoWindow ë‚´ë¶€ ìš”ì†Œë“¤ ë°°ê²½ ìœ ì§€ */
        .infowindow-content .title,
        .infowindow-content .bus-info-container {
            background: inherit !important;
        }

        /* ì (dot) ì œê±° */
        .infowindow-content .dot {
            display: none !important;
        }

        /* x í‘œì‹œ(ë‹«ê¸° ë²„íŠ¼) ì œê±° */
        .kakao_maps_sdk_infowindow .close {
            display: none !important;
        }

        /* ì¹´ì¹´ì˜¤ë§µ ê¸°ë³¸ ë‹«ê¸° ë²„íŠ¼ ìˆ¨ê¹€ */
        .kakao_maps_sdk_infowindow .closeBtn {
            display: none !important;
        }

        /* ì¶”ê°€ì ì¸ ë‹«ê¸° ë²„íŠ¼ ìš”ì†Œë“¤ ìˆ¨ê¹€ */
        .kakao_maps_sdk_infowindow [class*="close"],
        .kakao_maps_sdk_infowindow [class*="Close"],
        .kakao_maps_sdk_infowindow button[type="button"] {
            display: none !important;
        }

        /* ì¹´ì¹´ì˜¤ë§µ ê¸°ë³¸ ë‹«ê¸° ë²„íŠ¼ë§Œ ìˆ¨ê¹€ (ì»¤ìŠ¤í…€ ë‹«ê¸° ë²„íŠ¼ì€ ìœ ì§€) */
        .kakao_maps_sdk_infowindow .closeBtn {
            display: none !important;
        }

        .infowindow-content {
            position: relative;
            padding: 14px 18px;
            border-radius: 16px;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08);
            border: none;
            min-width: 140px;
            max-width: 300px;
            transform: translateY(10px);
            opacity: 0;
            animation: fadeInUp 0.3s ease forwards;
        }

        /* ì»¤ìŠ¤í…€ ë‹«ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .custom-close-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            border: none;
            outline: none;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .custom-close-btn:hover {
            background: rgba(255, 255, 255, 1);
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .custom-close-btn::before,
        .custom-close-btn::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 1px;
            background: currentColor;
            transform: rotate(45deg);
        }

        .custom-close-btn::after {
            transform: rotate(-45deg);
        }

        @keyframes fadeInUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .infowindow-content .title {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            white-space: nowrap;
            font-weight: 700;
            font-size: 16px;
            color: #1a1a1a;
            letter-spacing: -0.2px;
        }

        .infowindow-content .title .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .bus-info-container {
            display: grid;
            grid-gap: 6px;
            justify-items: stretch;
        }

        .bus-info-container.count-1 {
            grid-template-columns: 1fr;
        }

        .bus-info-container.count-2,
        .bus-info-container.count-3,
        .bus-info-container.count-4 {
            grid-template-columns: repeat(2, 1fr);
        }

        .bus-info-container.count-multi {
            grid-template-columns: repeat(3, 1fr);
        }

        .bus-info-container div {
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            background: #f9fafb;
            color: #333;
            text-align: center;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .bus-info-container div:hover {
            transform: translateY(-2px);
            background-color: #e6f0fa;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_API_KEY&libraries=services"
        onload="console.log('ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ')" onerror="console.error('ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨')"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
        var map;
        var markers = [];
        var busMarkers = [];
        var currentInfoWindow = null;

        // infoWindow ê´€ë ¨ í•¨ìˆ˜
        function closeCurrentInfoWindow() {
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
        }

        // ì»¤ìŠ¤í…€ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        function handleCustomCloseClick() {
            closeCurrentInfoWindow();
        }

        // InfoWindow border ê°•ì œ ì œê±° í•¨ìˆ˜
        function removeInfoWindowBorders() {
            try {
                console.log('ğŸ” [Border Debug] InfoWindow border ì œê±° ì‹œì‘');

                // ë‹¤ì–‘í•œ ê°€ëŠ¥í•œ InfoWindow ì„ íƒìë“¤
                const possibleSelectors = [
                    '.kakao_maps_sdk_infowindow',
                    '.kakao_maps_sdk_infowindow_',
                    '.kakao_maps_sdk_infowindow__',
                    '[class*="infowindow"]',
                    '[class*="InfoWindow"]',
                    '[class*="info-window"]',
                    '[class*="info_window"]',
                    '.kakao_maps_sdk_infowindow *',
                    'div[style*="position: absolute"]',
                    'div[style*="z-index"]'
                ];

                let foundInfoWindows = [];

                possibleSelectors.forEach(function (selector) {
                    try {
                        const elements = document.querySelectorAll(selector);
                        if (elements.length > 0) {
                            console.log(`ğŸ” [Border Debug] ì„ íƒì "${selector}"ì—ì„œ ${elements.length}ê°œ ìš”ì†Œ ë°œê²¬`);
                            foundInfoWindows = foundInfoWindows.concat(Array.from(elements));
                        }
                    } catch (e) {
                        console.log(`ğŸ” [Border Debug] ì„ íƒì "${selector}" ì˜¤ë¥˜:`, e);
                    }
                });

                // ì¤‘ë³µ ì œê±°
                foundInfoWindows = [...new Set(foundInfoWindows)];
                console.log('ğŸ” [Border Debug] ì´ ë°œê²¬ëœ InfoWindow ê°œìˆ˜:', foundInfoWindows.length);

                if (foundInfoWindows.length === 0) {
                    console.log('ğŸ” [Border Debug] InfoWindowë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ. DOM ì „ì²´ ê²€ìƒ‰ ì‹œì‘');

                    // DOM ì „ì²´ì—ì„œ InfoWindow ê´€ë ¨ ìš”ì†Œ ê²€ìƒ‰
                    const allDivs = document.querySelectorAll('div');
                    allDivs.forEach(function (div, index) {
                        if (index < 50) { // ì²˜ìŒ 50ê°œë§Œ ê²€ì‚¬
                            const style = window.getComputedStyle(div);
                            const className = div.className || '';
                            const id = div.id || '';

                            // InfoWindowë¡œ ë³´ì´ëŠ” ìš”ì†Œ ì°¾ê¸°
                            if (style.position === 'absolute' &&
                                (style.zIndex > 1000 || className.includes('info') || className.includes('window'))) {
                                console.log(`ğŸ” [Border Debug] ì ì¬ì  InfoWindow ë°œê²¬:`, {
                                    className: className,
                                    id: id,
                                    position: style.position,
                                    zIndex: style.zIndex,
                                    border: style.border
                                });

                                // border ì œê±°
                                div.style.border = 'none';
                                div.style.outline = 'none';
                                div.style.borderWidth = '0';
                                div.style.borderStyle = 'none';
                                div.style.borderColor = 'transparent';

                                // ë°°ê²½ ì œê±°
                                div.style.background = 'transparent';
                                div.style.backgroundColor = 'transparent';
                                div.style.backgroundImage = 'none';
                                div.style.backdropFilter = 'none';
                                div.style.webkitBackdropFilter = 'none';
                            }
                        }
                    });
                } else {
                    foundInfoWindows.forEach(function (infoWindow, index) {
                        console.log(`ğŸ” [Border Debug] InfoWindow ${index + 1} ì²˜ë¦¬ ì¤‘`);

                        // InfoWindow ìì²´ì˜ border ì œê±°
                        const originalBorder = infoWindow.style.border;
                        const originalOutline = infoWindow.style.outline;
                        console.log(`ğŸ” [Border Debug] InfoWindow ${index + 1} ì›ë³¸ border:`, originalBorder);
                        console.log(`ğŸ” [Border Debug] InfoWindow ${index + 1} ì›ë³¸ outline:`, originalOutline);

                        infoWindow.style.border = 'none';
                        infoWindow.style.outline = 'none';
                        infoWindow.style.borderWidth = '0';
                        infoWindow.style.borderStyle = 'none';
                        infoWindow.style.borderColor = 'transparent';

                        // InfoWindow ë°°ê²½ ì œê±° (ì™¸ë¶€ ë°˜íˆ¬ëª… ì˜ì—­)
                        infoWindow.style.background = 'transparent';
                        infoWindow.style.backgroundColor = 'transparent';
                        infoWindow.style.backgroundImage = 'none';
                        infoWindow.style.backdropFilter = 'none';
                        infoWindow.style.webkitBackdropFilter = 'none';

                        // InfoWindowì˜ ì²« ë²ˆì§¸ div (ì»¨í…Œì´ë„ˆ) ë°°ê²½ë„ ì œê±°
                        const firstDiv = infoWindow.querySelector('div:first-child');
                        if (firstDiv) {
                            firstDiv.style.background = 'transparent';
                            firstDiv.style.backgroundColor = 'transparent';
                            firstDiv.style.backgroundImage = 'none';
                            firstDiv.style.backdropFilter = 'none';
                            firstDiv.style.webkitBackdropFilter = 'none';
                        }

                        // ë‚´ë¶€ ëª¨ë“  ìš”ì†Œì˜ border ì œê±°
                        const allElements = infoWindow.querySelectorAll('*');
                        console.log(`ğŸ” [Border Debug] InfoWindow ${index + 1} ë‚´ë¶€ ìš”ì†Œ ê°œìˆ˜:`, allElements.length);

                        allElements.forEach(function (element, elementIndex) {
                            if (elementIndex < 10) { // ì²˜ìŒ 10ê°œ ìš”ì†Œë§Œ ë¡œê·¸
                                const elementBorder = element.style.border;
                                const elementOutline = element.style.outline;
                                if (elementBorder || elementOutline) {
                                    console.log(`ğŸ” [Border Debug] ìš”ì†Œ ${elementIndex} (${element.tagName}) border:`, elementBorder, 'outline:', elementOutline);
                                }
                            }
                            element.style.border = 'none';
                            element.style.outline = 'none';
                            element.style.borderWidth = '0';
                            element.style.borderStyle = 'none';
                            element.style.borderColor = 'transparent';

                            // ë°°ê²½ ì œê±° (ë‚´ë¶€ ìš”ì†ŒëŠ” ì œì™¸ - ë‚´ìš©ì´ ë³´ì´ë„ë¡)
                            if (!element.classList.contains('infowindow-content') &&
                                !element.classList.contains('title') &&
                                !element.classList.contains('bus-info-container')) {
                                element.style.background = 'transparent';
                                element.style.backgroundColor = 'transparent';
                                element.style.backgroundImage = 'none';
                                element.style.backdropFilter = 'none';
                                element.style.webkitBackdropFilter = 'none';
                            }
                        });

                        console.log(`ğŸ” [Border Debug] InfoWindow ${index + 1} border ì œê±° ì™„ë£Œ`);
                    });
                }

                // ì¶”ê°€: computed style í™•ì¸
                setTimeout(function () {
                    const computedInfoWindows = document.querySelectorAll('[class*="infowindow"], [class*="InfoWindow"]');
                    computedInfoWindows.forEach(function (infoWindow, index) {
                        const computedStyle = window.getComputedStyle(infoWindow);
                        console.log(`ğŸ” [Border Debug] InfoWindow ${index + 1} computed border:`, computedStyle.border);
                        console.log(`ğŸ” [Border Debug] InfoWindow ${index + 1} computed outline:`, computedStyle.outline);
                    });
                }, 100);

            } catch (error) {
                console.log('âŒ [Border Debug] Border ì œê±° ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        // InfoWindowê°€ ì—´ë¦´ ë•Œë§ˆë‹¤ border ì œê±°
        function openInfoWindowWithBorderRemoval(infoWindow, map, marker) {
            console.log('ğŸ” [Border Debug] InfoWindow ì—´ê¸° ì‹œì‘');
            openInfoWindow(infoWindow, map, marker);

            // ì—¬ëŸ¬ íƒ€ì´ë°ìœ¼ë¡œ border ì œê±° ì‹¤í–‰
            [50, 100, 200, 500, 1000].forEach(function (delay) {
                setTimeout(function () {
                    console.log(`ğŸ” [Border Debug] ${delay}ms í›„ border ì œê±° ì‹¤í–‰`);
                    removeInfoWindowBorders();
                }, delay);
            });
        }

        function openInfoWindow(infoWindow, map, marker) {
            closeCurrentInfoWindow();
            infoWindow.open(map, marker);
            currentInfoWindow = infoWindow;
        }

        // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
        function initMap(lat, lng, level) {
            try {
                var container = document.getElementById('map');
                var options = {
                    center: new kakao.maps.LatLng(lat || 35.8714, lng || 128.6014),
                    level: level || 3
                };
                map = new kakao.maps.Map(container, options);

                kakao.maps.event.addListener(map, 'click', function (mouseEvent) {
                    sendMessageToFlutter('mapClick', {
                        latitude: mouseEvent.latLng.getLat(),
                        longitude: mouseEvent.latLng.getLng()
                    });
                });

                sendMessageToFlutter('mapReady', {});
            } catch (error) {
                sendMessageToFlutter('mapError', { error: error.message });
            }
        }

        // â˜…â˜…â˜… ì •ë³´ì°½ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (í•µì‹¬ ìˆ˜ì •) â˜…â˜…â˜…
        function updateStationBusInfo(stationName, stationType, busInfo) {
            if (!currentInfoWindow || !currentInfoWindow.getContent()) return;

            const content = currentInfoWindow.getContent();
            if (!content.includes(stationName)) return;

            // 1. ë²„ìŠ¤ ê°œìˆ˜ íŒŒì•…
            const busCount = (busInfo.match(/<div>/g) || []).length;

            // 2. ë²„ìŠ¤ ê°œìˆ˜ì— ë”°ë¼ í´ë˜ìŠ¤ ì´ë¦„ ê²°ì •
            let countClass = 'count-multi'; // 5ê°œ ì´ìƒ ê¸°ë³¸ê°’
            if (busCount === 1) {
                countClass = 'count-1';
            } else if (busCount >= 2 && busCount <= 4) {
                countClass = `count-${busCount}`;
            }

            // 3. ìƒ‰ìƒ ë° ë©”ì¸ í´ë˜ìŠ¤ ê²°ì •
            let color = '#FF6B35'; // ê¸°ë³¸
            if (stationType === 'nearby') color = '#4CAF50';
            else if (stationType === 'route') color = '#2196F3';

            const mainClass = busCount === 1 ? 'infowindow-content single-bus-info' : 'infowindow-content';

            // 4. ìµœì¢… HTML ìƒì„±
            const updatedContent = `
                <div class="${mainClass}" style="border: none !important; outline: none !important; border-width: 0 !important; border-style: none !important; border-color: transparent !important;">
                    <button class="custom-close-btn" onclick="handleCustomCloseClick()"></button>
                    <div class="title">
                        <span style="color:${color};">${stationName}</span>
                    </div>
                    <div class="bus-info-container ${countClass}">
                        ${busInfo}
                    </div>
                </div>
            `;

            currentInfoWindow.setContent(updatedContent);

            // ì½˜í…ì¸  ì—…ë°ì´íŠ¸ í›„ border ì œê±°
            setTimeout(function () {
                removeInfoWindowBorders();
            }, 50);
        }

        // SVG ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
        function createSafeSVGMarker(svgContent, size, offset) {
            try {
                var cleanSvg = svgContent.replace(/\s+/g, ' ').replace(/>\s+</g, '><').trim();
                var encodedSvg = encodeURIComponent(cleanSvg);
                var dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodedSvg;
                return new kakao.maps.MarkerImage(dataUrl, size, { offset: offset });
            } catch (error) {
                var defaultMarkerUrl = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
                return new kakao.maps.MarkerImage(defaultMarkerUrl, size, { offset: offset });
            }
        }

        // ì •ë¥˜ì¥ ë§ˆì»¤ ì¶”ê°€ í•¨ìˆ˜
        function addStationMarker(lat, lng, name, type, sequenceNo) {
            var position = new kakao.maps.LatLng(lat, lng);
            var markerSvg, markerSize, markerOffset, color;

            if (type === 'route') {
                color = '#2196F3';
                markerSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40"><path d="M16 0C7.2 0 0 7.2 0 16c0 16 16 24 16 24s16-8 16-24C32 7.2 24.8 0 16 0z" fill="${color}" stroke="#FFFFFF" stroke-width="2"/><circle cx="16" cy="16" r="9" fill="white"/><text x="16" y="20" text-anchor="middle" fill="${color}" font-size="11" font-weight="bold">${sequenceNo || 'R'}</text></svg>`;
                markerSize = new kakao.maps.Size(32, 40);
                markerOffset = new kakao.maps.Point(16, 40);
            } else { // 'nearby'
                color = '#4CAF50';
                markerSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="36" viewBox="0 0 28 36"><path d="M14 0C6.3 0 0 6.3 0 14c0 14 14 22 14 22s14-8 14-22C28 6.3 21.7 0 14 0z" fill="${color}" stroke="#FFFFFF" stroke-width="2"/><circle cx="14" cy="14" r="8" fill="white"/><circle cx="14" cy="14" r="4" fill="${color}"/></svg>`;
                markerSize = new kakao.maps.Size(28, 36);
                markerOffset = new kakao.maps.Point(14, 36);
            }

            var marker = new kakao.maps.Marker({
                position: position,
                image: createSafeSVGMarker(markerSvg, markerSize, markerOffset)
            });
            marker.setMap(map);
            markers.push(marker);

            var initialContent = `<div class="infowindow-content" style="border: none !important; outline: none !important; border-width: 0 !important; border-style: none !important; border-color: transparent !important;"><button class="custom-close-btn" onclick="handleCustomCloseClick()"></button><div class="title"><span style="color:${color};">${name}</span></div><div style="font-size:12px; text-align:center;">ë²„ìŠ¤ ì •ë³´ ë¡œë”© ì¤‘...</div></div>`;
            var infowindow = new kakao.maps.InfoWindow({
                content: initialContent,
                removable: false,
                zIndex: 1000
            });

            kakao.maps.event.addListener(marker, 'click', function () {
                openInfoWindowWithBorderRemoval(infowindow, map, marker);
                sendMessageToFlutter('stationClick', { name: name, latitude: lat, longitude: lng, type: type, sequenceNo: sequenceNo });
            });
        }

        // í˜„ì¬ ìœ„ì¹˜, ë²„ìŠ¤ ë§ˆì»¤ ë° ê¸°íƒ€ í•¨ìˆ˜ë“¤... (ê¸°ì¡´ê³¼ ë™ì¼)
        function addCurrentLocationMarker(lat, lng) {
            var position = new kakao.maps.LatLng(lat, lng);
            var locationSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><circle cx="13" cy="13" r="12" fill="#FF4444" stroke="#FFFFFF" stroke-width="3"/><circle cx="13" cy="13" r="8" fill="#FFFFFF"/><circle cx="13" cy="13" r="4" fill="#FF4444"/><circle cx="13" cy="13" r="1" fill="#FFFFFF"/></svg>`;
            var marker = new kakao.maps.Marker({
                position: position,
                image: createSafeSVGMarker(locationSvg, new kakao.maps.Size(26, 26), new kakao.maps.Point(13, 13))
            });
            marker.setMap(map);
            markers.push(marker);
        }

        function addBusMarker(lat, lng, busNumber, routeId) {
            var position = new kakao.maps.LatLng(lat, lng);
            var busSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36"><circle cx="18" cy="18" r="16" fill="#FF9800" stroke="#FFFFFF" stroke-width="3"/><rect x="8" y="10" width="20" height="12" rx="2" fill="white"/><rect x="10" y="12" width="3" height="2" fill="#FF9800"/><rect x="16" y="12" width="3" height="2" fill="#FF9800"/><rect x="23" y="12" width="3" height="2" fill="#FF9800"/><circle cx="12" cy="25" r="1.5" fill="#333"/><circle cx="24" cy="25" r="1.5" fill="#333"/><text x="18" y="31" text-anchor="middle" fill="white" font-size="9" font-weight="bold">${(busNumber || routeId || 'BUS').substring(0, 4)}</text></svg>`;
            var marker = new kakao.maps.Marker({
                position: position,
                image: createSafeSVGMarker(busSvg, new kakao.maps.Size(36, 36), new kakao.maps.Point(18, 18))
            });
            marker.setMap(map);
            busMarkers.push(marker);
        }

        function clearMarkers() { markers.forEach(m => m.setMap(null)); markers = []; }
        function clearBusMarkers() { busMarkers.forEach(m => m.setMap(null)); busMarkers = []; }
        function moveToLocation(lat, lng, level) { map.setCenter(new kakao.maps.LatLng(lat, lng)); if (level) map.setLevel(level); }
        function sendMessageToFlutter(type, data) { if (window.mapEvent) window.mapEvent.postMessage(JSON.stringify({ type, data })); }

        // Flutterì—ì„œ í˜¸ì¶œí•  ì „ì—­ í•¨ìˆ˜ë“¤
        window.initMap = initMap;
        window.addCurrentLocationMarker = addCurrentLocationMarker;
        window.addStationMarker = addStationMarker;
        window.addBusMarker = addBusMarker;
        window.clearMarkers = clearMarkers;
        window.clearBusMarkers = clearBusMarkers;
        window.moveToLocation = moveToLocation;
        window.updateStationBusInfo = updateStationBusInfo;
    </script>
</body>

</html>