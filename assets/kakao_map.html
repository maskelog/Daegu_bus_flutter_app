<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Kakao Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        /* 기본 스타일 */
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* 정보창 스타일 */
        .kakao_maps_sdk_infowindow {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            transition: all 0.3s ease-in-out;
        }

        .infowindow-content {
            position: relative;
            padding: 14px 18px;
            padding-right: 40px;
            border-radius: 16px;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(240, 240, 240, 0.5);
            min-width: 140px;
            max-width: 300px;
            transform: translateY(10px);
            opacity: 0;
            animation: fadeInUp 0.3s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .infowindow-content .title {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            white-space: nowrap;
            font-weight: 700;
            font-size: 16px;
            color: #1a1a1a;
            letter-spacing: -0.2px;
        }

        .infowindow-content .title .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .bus-info-container {
            display: grid;
            grid-gap: 6px;
            justify-items: stretch;
        }

        .bus-info-container.count-1 {
            grid-template-columns: 1fr;
        }

        .bus-info-container.count-2,
        .bus-info-container.count-3,
        .bus-info-container.count-4 {
            grid-template-columns: repeat(2, 1fr);
        }

        .bus-info-container.count-multi {
            grid-template-columns: repeat(3, 1fr);
        }

        .bus-info-container div {
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            background: #f9fafb;
            color: #333;
            text-align: center;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .bus-info-container div:hover {
            transform: translateY(-2px);
            background-color: #e6f0fa;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_API_KEY&libraries=services"
        onload="console.log('카카오맵 스크립트 로드 완료')" onerror="console.error('카카오맵 스크립트 로드 실패')"></script>
    <script>
        // 전역 변수 선언
        var map;
        var markers = [];
        var busMarkers = [];
        var currentInfoWindow = null;

        // infoWindow 관련 함수
        function closeCurrentInfoWindow() {
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
        }

        function openInfoWindow(infoWindow, map, marker) {
            closeCurrentInfoWindow();
            infoWindow.open(map, marker);
            currentInfoWindow = infoWindow;
        }

        // 지도 초기화 함수
        function initMap(lat, lng, level) {
            try {
                var container = document.getElementById('map');
                var options = {
                    center: new kakao.maps.LatLng(lat || 35.8714, lng || 128.6014),
                    level: level || 3
                };
                map = new kakao.maps.Map(container, options);

                kakao.maps.event.addListener(map, 'click', function (mouseEvent) {
                    sendMessageToFlutter('mapClick', {
                        latitude: mouseEvent.latLng.getLat(),
                        longitude: mouseEvent.latLng.getLng()
                    });
                });

                sendMessageToFlutter('mapReady', {});
            } catch (error) {
                sendMessageToFlutter('mapError', { error: error.message });
            }
        }

        // ★★★ 정보창 업데이트 함수 (핵심 수정) ★★★
        function updateStationBusInfo(stationName, stationType, busInfo) {
            if (!currentInfoWindow || !currentInfoWindow.getContent()) return;

            const content = currentInfoWindow.getContent();
            if (!content.includes(stationName)) return;

            // 1. 버스 개수 파악
            const busCount = (busInfo.match(/<div>/g) || []).length;

            // 2. 버스 개수에 따라 클래스 이름 결정
            let countClass = 'count-multi'; // 5개 이상 기본값
            if (busCount === 1) {
                countClass = 'count-1';
            } else if (busCount >= 2 && busCount <= 4) {
                countClass = `count-${busCount}`;
            }

            // 3. 색상 및 메인 클래스 결정
            let color = '#FF6B35'; // 기본
            if (stationType === 'nearby') color = '#4CAF50';
            else if (stationType === 'route') color = '#2196F3';

            const mainClass = busCount === 1 ? 'infowindow-content single-bus-info' : 'infowindow-content';

            // 4. 최종 HTML 생성
            const updatedContent = `
                <div class="${mainClass}">
                    <div class="title">
                        <div class="dot" style="background-color:${color};"></div>
                        <span style="color:${color};">${stationName}</span>
                    </div>
                    <div class="bus-info-container ${countClass}">
                        ${busInfo}
                    </div>
                </div>
            `;

            currentInfoWindow.setContent(updatedContent);
        }

        // SVG 마커 생성 함수
        function createSafeSVGMarker(svgContent, size, offset) {
            try {
                var cleanSvg = svgContent.replace(/\s+/g, ' ').replace(/>\s+</g, '><').trim();
                var encodedSvg = encodeURIComponent(cleanSvg);
                var dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodedSvg;
                return new kakao.maps.MarkerImage(dataUrl, size, { offset: offset });
            } catch (error) {
                var defaultMarkerUrl = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
                return new kakao.maps.MarkerImage(defaultMarkerUrl, size, { offset: offset });
            }
        }

        // 정류장 마커 추가 함수
        function addStationMarker(lat, lng, name, type, sequenceNo) {
            var position = new kakao.maps.LatLng(lat, lng);
            var markerSvg, markerSize, markerOffset, color;

            if (type === 'route') {
                color = '#2196F3';
                markerSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40"><path d="M16 0C7.2 0 0 7.2 0 16c0 16 16 24 16 24s16-8 16-24C32 7.2 24.8 0 16 0z" fill="${color}" stroke="#FFFFFF" stroke-width="2"/><circle cx="16" cy="16" r="9" fill="white"/><text x="16" y="20" text-anchor="middle" fill="${color}" font-size="11" font-weight="bold">${sequenceNo || 'R'}</text></svg>`;
                markerSize = new kakao.maps.Size(32, 40);
                markerOffset = new kakao.maps.Point(16, 40);
            } else { // 'nearby'
                color = '#4CAF50';
                markerSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="36" viewBox="0 0 28 36"><path d="M14 0C6.3 0 0 6.3 0 14c0 14 14 22 14 22s14-8 14-22C28 6.3 21.7 0 14 0z" fill="${color}" stroke="#FFFFFF" stroke-width="2"/><circle cx="14" cy="14" r="8" fill="white"/><circle cx="14" cy="14" r="4" fill="${color}"/></svg>`;
                markerSize = new kakao.maps.Size(28, 36);
                markerOffset = new kakao.maps.Point(14, 36);
            }

            var marker = new kakao.maps.Marker({
                position: position,
                image: createSafeSVGMarker(markerSvg, markerSize, markerOffset)
            });
            marker.setMap(map);
            markers.push(marker);

            var initialContent = `<div class="infowindow-content"><div class="title"><div class="dot" style="background-color:${color};"></div><span style="color:${color};">${name}</span></div><div style="font-size:12px; text-align:center;">버스 정보 로딩 중...</div></div>`;
            var infowindow = new kakao.maps.InfoWindow({ content: initialContent, removable: true });

            kakao.maps.event.addListener(marker, 'click', function () {
                openInfoWindow(infowindow, map, marker);
                sendMessageToFlutter('stationClick', { name: name, latitude: lat, longitude: lng, type: type, sequenceNo: sequenceNo });
            });
        }

        // 현재 위치, 버스 마커 및 기타 함수들... (기존과 동일)
        function addCurrentLocationMarker(lat, lng) {
            var position = new kakao.maps.LatLng(lat, lng);
            var locationSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><circle cx="13" cy="13" r="12" fill="#FF4444" stroke="#FFFFFF" stroke-width="3"/><circle cx="13" cy="13" r="8" fill="#FFFFFF"/><circle cx="13" cy="13" r="4" fill="#FF4444"/><circle cx="13" cy="13" r="1" fill="#FFFFFF"/></svg>`;
            var marker = new kakao.maps.Marker({
                position: position,
                image: createSafeSVGMarker(locationSvg, new kakao.maps.Size(26, 26), new kakao.maps.Point(13, 13))
            });
            marker.setMap(map);
            markers.push(marker);
        }

        function addBusMarker(lat, lng, busNumber, routeId) {
            var position = new kakao.maps.LatLng(lat, lng);
            var busSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36"><circle cx="18" cy="18" r="16" fill="#FF9800" stroke="#FFFFFF" stroke-width="3"/><rect x="8" y="10" width="20" height="12" rx="2" fill="white"/><rect x="10" y="12" width="3" height="2" fill="#FF9800"/><rect x="16" y="12" width="3" height="2" fill="#FF9800"/><rect x="23" y="12" width="3" height="2" fill="#FF9800"/><circle cx="12" cy="25" r="1.5" fill="#333"/><circle cx="24" cy="25" r="1.5" fill="#333"/><text x="18" y="31" text-anchor="middle" fill="white" font-size="9" font-weight="bold">${(busNumber || routeId || 'BUS').substring(0, 4)}</text></svg>`;
            var marker = new kakao.maps.Marker({
                position: position,
                image: createSafeSVGMarker(busSvg, new kakao.maps.Size(36, 36), new kakao.maps.Point(18, 18))
            });
            marker.setMap(map);
            busMarkers.push(marker);
        }

        function clearMarkers() { markers.forEach(m => m.setMap(null)); markers = []; }
        function clearBusMarkers() { busMarkers.forEach(m => m.setMap(null)); busMarkers = []; }
        function moveToLocation(lat, lng, level) { map.setCenter(new kakao.maps.LatLng(lat, lng)); if (level) map.setLevel(level); }
        function sendMessageToFlutter(type, data) { if (window.mapEvent) window.mapEvent.postMessage(JSON.stringify({ type, data })); }

        // Flutter에서 호출할 전역 함수들
        window.initMap = initMap;
        window.addCurrentLocationMarker = addCurrentLocationMarker;
        window.addStationMarker = addStationMarker;
        window.addBusMarker = addBusMarker;
        window.clearMarkers = clearMarkers;
        window.clearBusMarkers = clearBusMarkers;
        window.moveToLocation = moveToLocation;
        window.updateStationBusInfo = updateStationBusInfo;
    </script>
</body>

</html>