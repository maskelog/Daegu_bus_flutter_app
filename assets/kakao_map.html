<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Kakao Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        /* 기본 스타일 */
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* 정보창 스타일 */
        .kakao_maps_sdk_infowindow {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            transition: all 0.3s ease-in-out;
        }

        /* 카카오맵 InfoWindow의 모든 border 제거 */
        .kakao_maps_sdk_infowindow * {
            border: none !important;
            outline: none !important;
        }

        /* 카카오맵 InfoWindow 자체의 border 제거 */
        .kakao_maps_sdk_infowindow,
        .kakao_maps_sdk_infowindow>div,
        .kakao_maps_sdk_infowindow>div>div {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }

        /* 모든 가능한 border 클래스 제거 */
        .kakao_maps_sdk_infowindow [class*="border"],
        .kakao_maps_sdk_infowindow [class*="Border"],
        .kakao_maps_sdk_infowindow [style*="border"] {
            border: none !important;
            outline: none !important;
        }

        /* 추가: 카카오맵 InfoWindow의 모든 스타일 재정의 */
        .kakao_maps_sdk_infowindow,
        .kakao_maps_sdk_infowindow *,
        .kakao_maps_sdk_infowindow *::before,
        .kakao_maps_sdk_infowindow *::after {
            border: none !important;
            outline: none !important;
            border-radius: 16px !important;
        }

        /* InfoWindow 컨테이너 자체의 border 제거 */
        .kakao_maps_sdk_infowindow {
            border: none !important;
            outline: none !important;
            background: transparent !important;
        }

        /* 모든 InfoWindow 관련 요소의 border 강제 제거 */
        .kakao_maps_sdk_infowindow,
        .kakao_maps_sdk_infowindow *,
        .kakao_maps_sdk_infowindow *::before,
        .kakao_maps_sdk_infowindow *::after,
        .kakao_maps_sdk_infowindow>div,
        .kakao_maps_sdk_infowindow>div>div,
        .kakao_maps_sdk_infowindow>div>div>div {
            border: none !important;
            outline: none !important;
            border-width: 0 !important;
            border-style: none !important;
            border-color: transparent !important;
        }

        /* 카카오맵 기본 InfoWindow 스타일 완전 재정의 */
        .kakao_maps_sdk_infowindow {
            border: none !important;
            outline: none !important;
            background: transparent !important;
            box-shadow: none !important;
        }

        /* InfoWindow 내부 모든 요소 border 제거 */
        .kakao_maps_sdk_infowindow div,
        .kakao_maps_sdk_infowindow span,
        .kakao_maps_sdk_infowindow button,
        .kakao_maps_sdk_infowindow input {
            border: none !important;
            outline: none !important;
        }

        /* 카카오맵 InfoWindow의 모든 가능한 border 스타일 완전 제거 */
        .kakao_maps_sdk_infowindow,
        .kakao_maps_sdk_infowindow *,
        .kakao_maps_sdk_infowindow *::before,
        .kakao_maps_sdk_infowindow *::after {
            border: none !important;
            outline: none !important;
            border-width: 0 !important;
            border-style: none !important;
            border-color: transparent !important;
            border-top: none !important;
            border-right: none !important;
            border-bottom: none !important;
            border-left: none !important;
            box-shadow: none !important;
        }

        /* 카카오맵 기본 InfoWindow 스타일 완전 재정의 */
        .kakao_maps_sdk_infowindow {
            border: none !important;
            outline: none !important;
            background: transparent !important;
            box-shadow: none !important;
            border-radius: 16px !important;
        }

        /* 추가: 모든 InfoWindow 관련 클래스에 border 제거 */
        [class*="infowindow"],
        [class*="InfoWindow"],
        [class*="info-window"],
        [class*="info_window"] {
            border: none !important;
            outline: none !important;
            border-width: 0 !important;
            border-style: none !important;
            border-color: transparent !important;
        }

        /* InfoWindow 배경 제거 */
        .kakao_maps_sdk_infowindow,
        .kakao_maps_sdk_infowindow *,
        [class*="infowindow"],
        [class*="InfoWindow"],
        [class*="info-window"],
        [class*="info_window"] {
            border: none !important;
            outline: none !important;
            border-width: 0 !important;
            border-style: none !important;
            border-color: transparent !important;
        }

        /* 카카오맵 기본 InfoWindow 배경 완전 제거 */
        .kakao_maps_sdk_infowindow {
            background: transparent !important;
            background-color: transparent !important;
            background-image: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        /* InfoWindow 컨테이너 배경 제거 (외부 반투명 영역) */
        .kakao_maps_sdk_infowindow>div:first-child {
            background: transparent !important;
            background-color: transparent !important;
            background-image: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        /* InfoWindow 내용 영역만 배경 유지 */
        .infowindow-content {
            background: linear-gradient(145deg, #ffffff, #f8f9fa) !important;
            background-color: #ffffff !important;
            border-radius: 16px !important;
            overflow: hidden !important;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08) !important;
        }

        /* InfoWindow 내부 요소들 배경 유지 */
        .infowindow-content .title,
        .infowindow-content .bus-info-container {
            background: inherit !important;
        }

        /* 점(dot) 제거 */
        .infowindow-content .dot {
            display: none !important;
        }

        /* x 표시(닫기 버튼) 제거 */
        .kakao_maps_sdk_infowindow .close {
            display: none !important;
        }

        /* 카카오맵 기본 닫기 버튼 숨김 */
        .kakao_maps_sdk_infowindow .closeBtn {
            display: none !important;
        }

        /* 추가적인 닫기 버튼 요소들 숨김 */
        .kakao_maps_sdk_infowindow [class*="close"],
        .kakao_maps_sdk_infowindow [class*="Close"],
        .kakao_maps_sdk_infowindow button[type="button"] {
            display: none !important;
        }

        /* 카카오맵 기본 닫기 버튼만 숨김 (커스텀 닫기 버튼은 유지) */
        .kakao_maps_sdk_infowindow .closeBtn {
            display: none !important;
        }

        .infowindow-content {
            position: relative;
            padding: 14px 18px;
            border-radius: 16px;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08);
            border: none;
            min-width: 140px;
            max-width: 300px;
            transform: translateY(10px);
            opacity: 0;
            animation: fadeInUp 0.3s ease forwards;
        }

        /* 커스텀 닫기 버튼 스타일 */
        .custom-close-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            border: none;
            outline: none;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #666;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .custom-close-btn:hover {
            background: rgba(255, 255, 255, 1);
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .custom-close-btn::before,
        .custom-close-btn::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 1px;
            background: currentColor;
            transform: rotate(45deg);
        }

        .custom-close-btn::after {
            transform: rotate(-45deg);
        }

        @keyframes fadeInUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .infowindow-content .title {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            white-space: nowrap;
            font-weight: 700;
            font-size: 16px;
            color: #1a1a1a;
            letter-spacing: -0.2px;
        }

        .infowindow-content .title .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .bus-info-container {
            display: grid;
            grid-gap: 6px;
            justify-items: stretch;
        }

        .bus-info-container.count-1 {
            grid-template-columns: 1fr;
        }

        .bus-info-container.count-2,
        .bus-info-container.count-3,
        .bus-info-container.count-4 {
            grid-template-columns: repeat(2, 1fr);
        }

        .bus-info-container.count-multi {
            grid-template-columns: repeat(3, 1fr);
        }

        .bus-info-container div {
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            background: #f9fafb;
            color: #333;
            text-align: center;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .bus-info-container div:hover {
            transform: translateY(-2px);
            background-color: #e6f0fa;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_API_KEY"
        onload="sendMessageToFlutter('mapLoaded', {})" onerror="console.error('카카오맵 스크립트 로드 실패')"></script>
    <script>
        // 전역 변수 선언
        var map;
        var markers = [];
        var busMarkers = [];
        var currentInfoWindow = null;

        // infoWindow 관련 함수
        function closeCurrentInfoWindow() {
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
        }

        // 커스텀 닫기 버튼 클릭 이벤트 핸들러
        function handleCustomCloseClick() {
            closeCurrentInfoWindow();
        }

        // InfoWindow border 강제 제거 함수
        function removeInfoWindowBorders() {
            try {
                // InfoWindow border 제거 로직...
            } catch (error) {
                // console.log('❌ [Border Debug] Border 제거 중 오류:', error);
            }
        }

        // InfoWindow가 열릴 때마다 border 제거
        function openInfoWindowWithBorderRemoval(infoWindow, map, marker) {
            openInfoWindow(infoWindow, map, marker);

            // 여러 타이밍으로 border 제거 실행
            [50, 100, 200, 500].forEach(function (delay) {
                setTimeout(function () {
                    removeInfoWindowBorders();
                }, delay);
            });
        }

        function openInfoWindow(infoWindow, map, marker) {
            closeCurrentInfoWindow();
            infoWindow.open(map, marker);
            currentInfoWindow = infoWindow;
        }

        // 지도 초기화 함수
        function initMap(lat, lng, level) {
            try {
                var container = document.getElementById('map');
                var options = {
                    center: new kakao.maps.LatLng(lat || 35.8714, lng || 128.6014),
                    level: level || 3
                };
                map = new kakao.maps.Map(container, options);

                kakao.maps.event.addListener(map, 'click', function (mouseEvent) {
                    sendMessageToFlutter('mapClick', {
                        latitude: mouseEvent.latLng.getLat(),
                        longitude: mouseEvent.latLng.getLng()
                    });
                });

                sendMessageToFlutter('mapReady', {});
            } catch (error) {
                sendMessageToFlutter('mapError', { error: error.message });
            }
        }

        // ★★★ 정보창 업데이트 함수 (핵심 수정) ★★★
        function updateStationBusInfo(stationName, stationType, busInfo) {
            if (!currentInfoWindow || !currentInfoWindow.getContent()) return;

            const content = currentInfoWindow.getContent();
            if (!content.includes(stationName)) return;

            // 1. 버스 개수 파악
            const busCount = (busInfo.match(/<div>/g) || []).length;

            // 2. 버스 개수에 따라 클래스 이름 결정
            let countClass = 'count-multi'; // 5개 이상 기본값
            if (busCount === 1) {
                countClass = 'count-1';
            } else if (busCount >= 2 && busCount <= 4) {
                countClass = `count-${busCount}`;
            }

            // 3. 색상 및 메인 클래스 결정
            let color = '#FF6B35'; // 기본
            if (stationType === 'nearby') color = '#4CAF50';
            else if (stationType === 'route') color = '#2196F3';

            const mainClass = busCount === 1 ? 'infowindow-content single-bus-info' : 'infowindow-content';

            // 4. 최종 HTML 생성
            const updatedContent = `
                <div class="${mainClass}" style="border: none !important; outline: none !important; border-width: 0 !important; border-style: none !important; border-color: transparent !important;">
                    <button class="custom-close-btn" onclick="handleCustomCloseClick()"></button>
                    <div class="title">
                        <span style="color:${color};">${stationName}</span>
                    </div>
                    <div class="bus-info-container ${countClass}">
                        ${busInfo}
                    </div>
                </div>
            `;

            currentInfoWindow.setContent(updatedContent);

            // 콘텐츠 업데이트 후 border 제거
            setTimeout(function () {
                removeInfoWindowBorders();
            }, 50);
        }

        // SVG 마커 생성 함수
        function createSafeSVGMarker(svgContent, size, offset) {
            try {
                var cleanSvg = svgContent.replace(/\s+/g, ' ').replace(/>\s+</g, '><').trim();
                var encodedSvg = encodeURIComponent(cleanSvg);
                var dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodedSvg;
                return new kakao.maps.MarkerImage(dataUrl, size, { offset: offset });
            } catch (error) {
                var defaultMarkerUrl = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
                return new kakao.maps.MarkerImage(defaultMarkerUrl, size, { offset: offset });
            }
        }

        // 정류장 마커 추가 함수
        function addStationMarker(lat, lng, name, type, sequenceNo) {
            var position = new kakao.maps.LatLng(lat, lng);
            var markerSvg, markerSize, markerOffset, color;

            if (type === 'route') {
                color = '#2196F3';
                markerSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40"><path d="M16 0C7.2 0 0 7.2 0 16c0 16 16 24 16 24s16-8 16-24C32 7.2 24.8 0 16 0z" fill="${color}" stroke="#FFFFFF" stroke-width="2"/><circle cx="16" cy="16" r="9" fill="white"/><text x="16" y="20" text-anchor="middle" fill="${color}" font-size="11" font-weight="bold">${sequenceNo || 'R'}</text></svg>`;
                markerSize = new kakao.maps.Size(32, 40);
                markerOffset = new kakao.maps.Point(16, 40);
            } else { // 'nearby'
                color = '#4CAF50';
                markerSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="36" viewBox="0 0 28 36"><path d="M14 0C6.3 0 0 6.3 0 14c0 14 14 22 14 22s14-8 14-22C28 6.3 21.7 0 14 0z" fill="${color}" stroke="#FFFFFF" stroke-width="2"/><circle cx="14" cy="14" r="8" fill="white"/><circle cx="14" cy="14" r="4" fill="${color}"/></svg>`;
                markerSize = new kakao.maps.Size(28, 36);
                markerOffset = new kakao.maps.Point(14, 36);
            }

            var marker = new kakao.maps.Marker({
                position: position,
                image: createSafeSVGMarker(markerSvg, markerSize, markerOffset)
            });
            marker.setMap(map);
            markers.push(marker);

            var initialContent = `<div class="infowindow-content" style="border: none !important; outline: none !important; border-width: 0 !important; border-style: none !important; border-color: transparent !important;"><button class="custom-close-btn" onclick="handleCustomCloseClick()"></button><div class="title"><span style="color:${color};">${name}</span></div><div style="font-size:12px; text-align:center;">버스 정보 로딩 중...</div></div>`;
            var infowindow = new kakao.maps.InfoWindow({
                content: initialContent,
                removable: false,
                zIndex: 1000
            });

            kakao.maps.event.addListener(marker, 'click', function () {
                openInfoWindowWithBorderRemoval(infowindow, map, marker);
                sendMessageToFlutter('stationClick', { name: name, latitude: lat, longitude: lng, type: type, sequenceNo: sequenceNo });
            });
        }

        // 현재 위치, 버스 마커 및 기타 함수들... (기존과 동일)
        function addCurrentLocationMarker(lat, lng) {
            var position = new kakao.maps.LatLng(lat, lng);
            var locationSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><circle cx="13" cy="13" r="12" fill="#FF4444" stroke="#FFFFFF" stroke-width="3"/><circle cx="13" cy="13" r="8" fill="#FFFFFF"/><circle cx="13" cy="13" r="4" fill="#FF4444"/><circle cx="13" cy="13" r="1" fill="#FFFFFF"/></svg>`;
            var marker = new kakao.maps.Marker({
                position: position,
                image: createSafeSVGMarker(locationSvg, new kakao.maps.Size(26, 26), new kakao.maps.Point(13, 13))
            });
            marker.setMap(map);
            markers.push(marker);
        }

        function addBusMarker(lat, lng, busNumber, routeId) {
            var position = new kakao.maps.LatLng(lat, lng);
            var busSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36"><circle cx="18" cy="18" r="16" fill="#FF9800" stroke="#FFFFFF" stroke-width="3"/><rect x="8" y="10" width="20" height="12" rx="2" fill="white"/><rect x="10" y="12" width="3" height="2" fill="#FF9800"/><rect x="16" y="12" width="3" height="2" fill="#FF9800"/><rect x="23" y="12" width="3" height="2" fill="#FF9800"/><circle cx="12" cy="25" r="1.5" fill="#333"/><circle cx="24" cy="25" r="1.5" fill="#333"/><text x="18" y="31" text-anchor="middle" fill="white" font-size="9" font-weight="bold">${(busNumber || routeId || 'BUS').substring(0, 4)}</text></svg>`;
            var marker = new kakao.maps.Marker({
                position: position,
                image: createSafeSVGMarker(busSvg, new kakao.maps.Size(36, 36), new kakao.maps.Point(18, 18))
            });
            marker.setMap(map);
            busMarkers.push(marker);
        }

        function clearMarkers() { markers.forEach(m => m.setMap(null)); markers = []; }
        function clearBusMarkers() { busMarkers.forEach(m => m.setMap(null)); busMarkers = []; }
        function moveToLocation(lat, lng, level) { map.setCenter(new kakao.maps.LatLng(lat, lng)); if (level) map.setLevel(level); }
        function sendMessageToFlutter(type, data) { if (window.mapEvent) window.mapEvent.postMessage(JSON.stringify({ type, data })); }

        // Flutter에서 호출할 전역 함수들
        window.initMap = initMap;
        window.addCurrentLocationMarker = addCurrentLocationMarker;
        window.addStationMarker = addStationMarker;
        window.addBusMarker = addBusMarker;
        window.clearMarkers = clearMarkers;
        window.clearBusMarkers = clearBusMarkers;
        window.moveToLocation = moveToLocation;
        window.updateStationBusInfo = updateStationBusInfo;
    </script>
</body>

</html>